# Generated by Django 5.2.7 on 2025-11-08 13:25

import django.db.models.deletion
import django.utils.timezone
from django.conf import settings
from django.db import migrations, models


class Migration(migrations.Migration):

    initial = True

    dependencies = [
        ('ap', '0002_initial'),
        ('catalog', '0001_initial'),
        ('core', '0001_initial'),
        ('purchase_orders', '0002_initial'),
        ('receiving', '0001_initial'),
        migrations.swappable_dependency(settings.AUTH_USER_MODEL),
    ]

    operations = [
        migrations.CreateModel(
            name='VendorBill',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('bill_number', models.CharField(db_index=True, max_length=50, unique=True)),
                ('supplier_invoice_number', models.CharField(db_index=True, help_text="Vendor's invoice number", max_length=100)),
                ('supplier_invoice_date', models.DateField()),
                ('bill_type', models.CharField(choices=[('STANDARD', 'Standard Bill'), ('CREDIT_MEMO', 'Credit Memo'), ('DEBIT_MEMO', 'Debit Memo'), ('PREPAYMENT', 'Prepayment')], default='STANDARD', max_length=20)),
                ('bill_date', models.DateField(default=django.utils.timezone.now)),
                ('due_date', models.DateField()),
                ('subtotal', models.DecimalField(decimal_places=2, default=0, max_digits=15)),
                ('tax_amount', models.DecimalField(decimal_places=2, default=0, max_digits=15)),
                ('total_amount', models.DecimalField(decimal_places=2, default=0, max_digits=15)),
                ('exchange_rate', models.DecimalField(decimal_places=6, default=1, max_digits=15)),
                ('base_currency_total', models.DecimalField(decimal_places=2, default=0, help_text='Total in base currency', max_digits=15)),
                ('status', models.CharField(choices=[('DRAFT', 'Draft'), ('SUBMITTED', 'Submitted'), ('MATCHED', 'Matched'), ('EXCEPTION', 'Exception'), ('APPROVED', 'Approved'), ('POSTED_TO_AP', 'Posted to AP'), ('PAID', 'Paid'), ('REJECTED', 'Rejected'), ('CANCELLED', 'Cancelled')], db_index=True, default='DRAFT', max_length=20)),
                ('is_matched', models.BooleanField(default=False)),
                ('match_date', models.DateTimeField(blank=True, null=True)),
                ('has_exceptions', models.BooleanField(db_index=True, default=False)),
                ('exception_count', models.IntegerField(default=0)),
                ('ap_posted_date', models.DateTimeField(blank=True, null=True)),
                ('is_paid', models.BooleanField(default=False)),
                ('paid_date', models.DateField(blank=True, null=True)),
                ('paid_amount', models.DecimalField(decimal_places=2, default=0, max_digits=15)),
                ('approval_status', models.CharField(choices=[('PENDING', 'Pending'), ('APPROVED', 'Approved'), ('REJECTED', 'Rejected')], default='PENDING', max_length=20)),
                ('approved_date', models.DateTimeField(blank=True, null=True)),
                ('notes', models.TextField(blank=True)),
                ('internal_notes', models.TextField(blank=True, help_text='Internal notes not visible to supplier')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('ap_invoice', models.ForeignKey(blank=True, help_text='Created AP Invoice (idempotent)', null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='vendor_bill', to='ap.apinvoice')),
                ('ap_posted_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='ap_posted_bills', to=settings.AUTH_USER_MODEL)),
                ('approved_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='approved_bills', to=settings.AUTH_USER_MODEL)),
                ('created_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='created_bills', to=settings.AUTH_USER_MODEL)),
                ('currency', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='core.currency')),
                ('grn_header', models.ForeignKey(blank=True, help_text='Goods Receipt Note for 3-way match', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='vendor_bills', to='receiving.goodsreceipt')),
                ('po_header', models.ForeignKey(blank=True, help_text='Purchase Order for 3-way match', null=True, on_delete=django.db.models.deletion.PROTECT, related_name='vendor_bills', to='purchase_orders.poheader')),
                ('supplier', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, related_name='vendor_bills', to='ap.supplier')),
                ('updated_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='updated_bills', to=settings.AUTH_USER_MODEL)),
            ],
            options={
                'verbose_name': 'Vendor Bill',
                'verbose_name_plural': 'Vendor Bills',
                'db_table': 'vendor_bill_vendorbill',
                'ordering': ['-bill_date', '-bill_number'],
            },
        ),
        migrations.CreateModel(
            name='VendorBillLine',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('line_number', models.IntegerField()),
                ('description', models.CharField(max_length=500)),
                ('quantity', models.DecimalField(decimal_places=3, max_digits=15)),
                ('unit_price', models.DecimalField(decimal_places=4, max_digits=15)),
                ('line_total', models.DecimalField(decimal_places=2, max_digits=15)),
                ('tax_rate', models.DecimalField(decimal_places=2, default=0, help_text='Tax rate as percentage', max_digits=5)),
                ('tax_amount', models.DecimalField(decimal_places=2, default=0, max_digits=15)),
                ('po_number', models.CharField(blank=True, db_index=True, help_text='PO number from vendor bill', max_length=50)),
                ('po_line_number', models.IntegerField(blank=True, help_text='PO line number from vendor bill', null=True)),
                ('grn_number', models.CharField(blank=True, db_index=True, help_text='GRN number from vendor bill', max_length=50)),
                ('is_matched', models.BooleanField(default=False)),
                ('has_exception', models.BooleanField(default=False)),
                ('notes', models.TextField(blank=True)),
                ('catalog_item', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, to='catalog.catalogitem')),
                ('unit_of_measure', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='catalog.unitofmeasure')),
                ('vendor_bill', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='lines', to='vendor_bills.vendorbill')),
            ],
            options={
                'verbose_name': 'Vendor Bill Line',
                'verbose_name_plural': 'Vendor Bill Lines',
                'db_table': 'vendor_bill_vendorbillline',
                'ordering': ['line_number'],
            },
        ),
        migrations.CreateModel(
            name='ThreeWayMatch',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('match_number', models.CharField(db_index=True, max_length=50, unique=True)),
                ('po_number', models.CharField(blank=True, db_index=True, max_length=50)),
                ('po_line_number', models.IntegerField(blank=True, null=True)),
                ('po_quantity', models.DecimalField(decimal_places=3, default=0, help_text='Quantity ordered in PO', max_digits=15)),
                ('grn_quantity', models.DecimalField(decimal_places=3, default=0, help_text='Quantity received in GRN', max_digits=15)),
                ('bill_quantity', models.DecimalField(decimal_places=3, default=0, help_text='Quantity billed', max_digits=15)),
                ('po_unit_price', models.DecimalField(decimal_places=4, default=0, help_text='Unit price in PO', max_digits=15)),
                ('bill_unit_price', models.DecimalField(decimal_places=4, default=0, help_text='Unit price in bill', max_digits=15)),
                ('quantity_variance', models.DecimalField(decimal_places=3, default=0, help_text='Bill qty - GRN qty', max_digits=15)),
                ('quantity_variance_pct', models.DecimalField(decimal_places=2, default=0, help_text='Variance as percentage', max_digits=5)),
                ('price_variance', models.DecimalField(decimal_places=4, default=0, help_text='Bill price - PO price', max_digits=15)),
                ('price_variance_pct', models.DecimalField(decimal_places=2, default=0, help_text='Variance as percentage', max_digits=5)),
                ('quantity_tolerance_exceeded', models.BooleanField(default=False)),
                ('price_tolerance_exceeded', models.BooleanField(default=False)),
                ('match_status', models.CharField(choices=[('MATCHED', 'Matched'), ('EXCEPTION', 'Exception'), ('PARTIALLY_MATCHED', 'Partially Matched'), ('UNMATCHED', 'Unmatched')], db_index=True, default='UNMATCHED', max_length=20)),
                ('has_exception', models.BooleanField(db_index=True, default=False)),
                ('matched_date', models.DateTimeField(auto_now_add=True)),
                ('notes', models.TextField(blank=True)),
                ('catalog_item', models.ForeignKey(on_delete=django.db.models.deletion.PROTECT, to='catalog.catalogitem')),
                ('grn_line', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.PROTECT, related_name='match_records', to='receiving.grnline')),
                ('matched_by', models.ForeignKey(null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='matched_documents', to=settings.AUTH_USER_MODEL)),
                ('vendor_bill_line', models.ForeignKey(on_delete=django.db.models.deletion.CASCADE, related_name='match_records', to='vendor_bills.vendorbillline')),
            ],
            options={
                'verbose_name': '3-Way Match',
                'verbose_name_plural': '3-Way Matches',
                'db_table': 'vendor_bill_threewaymatch',
                'ordering': ['-matched_date'],
            },
        ),
        migrations.CreateModel(
            name='MatchTolerance',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('scope', models.CharField(choices=[('GLOBAL', 'Global Default'), ('SUPPLIER', 'Supplier Specific'), ('CATEGORY', 'Category Specific'), ('ITEM', 'Item Specific')], default='GLOBAL', max_length=20)),
                ('quantity_tolerance_pct', models.DecimalField(decimal_places=2, default=5.0, help_text='Quantity tolerance as percentage (default 5%)', max_digits=5)),
                ('price_tolerance_pct', models.DecimalField(decimal_places=2, default=3.0, help_text='Price tolerance as percentage (default 3%)', max_digits=5)),
                ('auto_approve_threshold', models.DecimalField(decimal_places=2, default=1000, help_text='Auto-approve exceptions below this amount', max_digits=15)),
                ('is_active', models.BooleanField(default=True)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('catalog_item', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='match_tolerances', to='catalog.catalogitem')),
                ('supplier', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.CASCADE, related_name='match_tolerances', to='ap.supplier')),
            ],
            options={
                'verbose_name': 'Match Tolerance',
                'verbose_name_plural': 'Match Tolerances',
                'db_table': 'vendor_bill_matchtolerance',
                'ordering': ['scope', '-created_at'],
                'indexes': [models.Index(fields=['scope', 'is_active'], name='vendor_bill_scope_23d668_idx'), models.Index(fields=['supplier'], name='vendor_bill_supplie_c4d291_idx'), models.Index(fields=['catalog_item'], name='vendor_bill_catalog_c0359b_idx')],
            },
        ),
        migrations.CreateModel(
            name='MatchException',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('exception_number', models.CharField(db_index=True, max_length=50, unique=True)),
                ('exception_type', models.CharField(choices=[('QUANTITY_OVER', 'Quantity Over Tolerance'), ('QUANTITY_UNDER', 'Quantity Under Tolerance'), ('PRICE_OVER', 'Price Over Tolerance'), ('PRICE_UNDER', 'Price Under Tolerance'), ('PO_NOT_FOUND', 'PO Not Found'), ('GRN_NOT_FOUND', 'GRN Not Found'), ('ITEM_MISMATCH', 'Item Mismatch'), ('DUPLICATE_BILL', 'Duplicate Bill'), ('OTHER', 'Other')], max_length=30)),
                ('severity', models.CharField(choices=[('LOW', 'Low'), ('MEDIUM', 'Medium'), ('HIGH', 'High'), ('CRITICAL', 'Critical')], default='MEDIUM', max_length=20)),
                ('description', models.TextField(help_text='Auto-generated description of the exception')),
                ('variance_amount', models.DecimalField(decimal_places=4, default=0, help_text='Absolute variance amount', max_digits=15)),
                ('variance_percentage', models.DecimalField(decimal_places=2, default=0, help_text='Variance as percentage', max_digits=5)),
                ('financial_impact', models.DecimalField(decimal_places=2, default=0, help_text='Financial impact of variance', max_digits=15)),
                ('resolution_status', models.CharField(choices=[('UNRESOLVED', 'Unresolved'), ('IN_REVIEW', 'In Review'), ('RESOLVED', 'Resolved'), ('WAIVED', 'Waived')], db_index=True, default='UNRESOLVED', max_length=20)),
                ('resolution_action', models.CharField(blank=True, choices=[('ADJUST_BILL', 'Adjust Bill'), ('ADJUST_PO', 'Adjust PO'), ('ADJUST_GRN', 'Adjust GRN'), ('WAIVE', 'Waive Exception'), ('REJECT_BILL', 'Reject Bill'), ('CONTACT_SUPPLIER', 'Contact Supplier'), ('OTHER', 'Other')], max_length=30)),
                ('resolution_notes', models.TextField(blank=True)),
                ('resolved_date', models.DateTimeField(blank=True, null=True)),
                ('requires_approval', models.BooleanField(default=False)),
                ('approved_date', models.DateTimeField(blank=True, null=True)),
                ('blocks_posting', models.BooleanField(default=True, help_text='If True, blocks AP posting until resolved')),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('approved_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='approved_exceptions', to=settings.AUTH_USER_MODEL)),
                ('resolved_by', models.ForeignKey(blank=True, null=True, on_delete=django.db.models.deletion.SET_NULL, related_name='resolved_exceptions', to=settings.AUTH_USER_MODEL)),
                ('three_way_match', models.OneToOneField(on_delete=django.db.models.deletion.CASCADE, related_name='exception', to='vendor_bills.threewaymatch')),
            ],
            options={
                'verbose_name': 'Match Exception',
                'verbose_name_plural': 'Match Exceptions',
                'db_table': 'vendor_bill_matchexception',
                'ordering': ['-created_at'],
                'indexes': [models.Index(fields=['resolution_status', 'created_at'], name='vendor_bill_resolut_adb1aa_idx'), models.Index(fields=['exception_type', 'resolution_status'], name='vendor_bill_excepti_7f44dd_idx'), models.Index(fields=['blocks_posting', 'resolution_status'], name='vendor_bill_blocks__b60609_idx')],
            },
        ),
        migrations.AddIndex(
            model_name='vendorbill',
            index=models.Index(fields=['status', 'bill_date'], name='vendor_bill_status_28d65a_idx'),
        ),
        migrations.AddIndex(
            model_name='vendorbill',
            index=models.Index(fields=['supplier', 'bill_date'], name='vendor_bill_supplie_1a2e47_idx'),
        ),
        migrations.AddIndex(
            model_name='vendorbill',
            index=models.Index(fields=['supplier_invoice_number', 'supplier'], name='vendor_bill_supplie_6ebf76_idx'),
        ),
        migrations.AddIndex(
            model_name='vendorbill',
            index=models.Index(fields=['has_exceptions', 'status'], name='vendor_bill_has_exc_a234f8_idx'),
        ),
        migrations.AddIndex(
            model_name='vendorbillline',
            index=models.Index(fields=['catalog_item'], name='vendor_bill_catalog_bd28d3_idx'),
        ),
        migrations.AddIndex(
            model_name='vendorbillline',
            index=models.Index(fields=['po_number', 'po_line_number'], name='vendor_bill_po_numb_b59be9_idx'),
        ),
        migrations.AlterUniqueTogether(
            name='vendorbillline',
            unique_together={('vendor_bill', 'line_number')},
        ),
        migrations.AddIndex(
            model_name='threewaymatch',
            index=models.Index(fields=['match_status', 'matched_date'], name='vendor_bill_match_s_fccd01_idx'),
        ),
        migrations.AddIndex(
            model_name='threewaymatch',
            index=models.Index(fields=['has_exception', 'match_status'], name='vendor_bill_has_exc_effae0_idx'),
        ),
        migrations.AddIndex(
            model_name='threewaymatch',
            index=models.Index(fields=['catalog_item'], name='vendor_bill_catalog_40e11d_idx'),
        ),
    ]
